<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blood Donor Directory</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="icon" href="fav2.png" type="image/png" />

  <style>
    /* üåê Base Styling */
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f8f8f8;
  margin: 0;
}

h1 {
  color: #d62828;
  text-align: center;
  font-size: 28px;
  margin-bottom: 20px;
}

/* üì± Input and Button Styling */
input, select, button {
  padding: 12px;
  font-size: 16px;
  min-width: 150px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#filterContainer,
#buttonContainer {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

/* üßæ Table Styling */
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}

th {
  background-color: #d62828;
  color: white;
}

tr:hover {
  background-color: #ffe5e5;
}

/* üåë Dark Mode Support */
body.dark-mode {
  background-color: #121212;
  color: #e0e0e0;
}

body.dark-mode table {
  background-color: #1e1e1e;
  color: #fff;
}

body.dark-mode th {
  background-color: #bb0000;
  color: #fff;
}

body.dark-mode td {
  border-color: #444;
}

body.dark-mode tr:hover {
  background-color: #333;
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode button {
  background-color: #333;
  color: #eee;
  border: 1px solid #555;
}

/* üì≤ Mobile-First Responsive Table */
@media screen and (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }

  thead tr {
    display: none;
  }

  td {
    position: relative;
    padding-left: 50%;
    text-align: left;
    font-size: 14px;
  }

  td::before {
    content: attr(data-label);
    position: absolute;
    left: 10px;
    top: 10px;
    font-weight: bold;
    color: #d62828;
  }
}

/* üîÑ Very Small Screens (Extra Enhancements) */
@media screen and (max-width: 480px) {
  table {
    overflow-x: auto;
    white-space: nowrap;
  }

  h1 {
    font-size: 22px;
  }

  td {
    font-size: 12px;
  }

  input, select, button {
    font-size: 14px;
    padding: 10px;
  }
}

/* üìå Sticky Buttons (Optional UI improvement) */
#buttonContainer {
  position: sticky;
  top: 0;
  background: #f8f8f8;
  z-index: 1000;
  padding: 10px;
}

body.dark-mode #buttonContainer {
  background: #121212;
}
.sort-controls {
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: center;
}

.sort-controls label,
.sort-controls select,
.sort-controls button {
  font-size: 16px;
  padding: 5px;
}

  </style>
</head>
<body>
  <h1>ü©∏ Blood Donor Directory</h1>

  <div id="filterContainer">
    <input type="text" id="searchName" placeholder="Search by Name" />
    <select id="searchLocationDropdown"><option value="">All Locations</option></select>
    <select id="searchGroup"><option value="">All Blood Groups</option></select>
  </div>

  <div id="buttonContainer">
    <button id="darkModeToggle">üåô Toggle Dark Mode</button>

    <button onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
    <button onclick="exportPDF()">üßæ Export PDF</button>
  </div>
  <!-- Sort Controls -->
<div class="sort-controls">
  <label for="sortColumn">Sort by:</label>
  <select id="sortColumn">
    <option value="">-- Select Column --</option>
    <option value="Full name">Full Name</option>
    <option value="Blood Group(Enter in Bold. Eg:- B+)">Blood Group</option>
    <option value="Current Address (Enter District)">Location</option>
  </select>

  <select id="sortOrder">
    <option value="asc">A ‚Üí Z</option>
    <option value="desc">Z ‚Üí A</option>
  </select>

  <button onclick="sortTable()">Sort</button>
</div>

  <table id="donorTable">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Age</th>
        <th>Gender</th>
        <th>Contact Number</th>
        <th>Email</th>
        <th>Permanent Address</th>
        <th>Current Address</th>
        <th>Blood Group</th>
        <th>Willing to Donate?</th>
        <th>Health Conditions</th>
      </tr>
    </thead>
    <tbody id="donorTableBody"></tbody>
  </table>

<script>
// Dark Mode Toggle Logic
const toggleButton = document.getElementById("darkModeToggle");

toggleButton.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("darkMode", document.body.classList.contains("dark-mode") ? "enabled" : "disabled");
});

// Load preference on startup
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("darkMode") === "enabled") {
    document.body.classList.add("dark-mode");
  }
});


const API_URL = "https://script.google.com/macros/s/AKfycbyjmCO2uQfhMpjKtPwZB0f9CL70E_uOjP40Vx7xXxCO6CV8NYCgpClQqJzTZ7cgoKoKqg/exec";
let donors = [];
let filteredDonors = [];

async function fetchData() {
  try {
    const response = await fetch(API_URL);
    donors = await response.json();
    filteredDonors = donors;
    renderTable(filteredDonors);
    populateDropdowns(donors);
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

function renderTable(data) {
  const tbody = document.getElementById("donorTableBody");
  tbody.innerHTML = "";

  data.forEach(donor => {
    const row = document.createElement("tr");
    const fields = [
      "Full name", "Age", "Gender", "Contact number", "Email",
      "Permanent Address(Enter District)", "Current Address (Enter District)",
      "Blood Group(Enter in Bold. Eg:- B+)",
      "Are you willing to donate blood in future emergencies?  ",
      "Any existing health conditions?"
    ];

    fields.forEach(field => {
      const cell = document.createElement("td");
      cell.setAttribute("data-label", field);
      cell.textContent = donor[field] || "-";
      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });
}

function exportCSV() {
  if (filteredDonors.length === 0) return alert("No data to export.");
  let csv = "Full Name,Age,Gender,Contact Number,Email,Permanent Address,Current Address,Blood Group,Willing to Donate?,Health Conditions\n";
  
  filteredDonors.forEach(d => {
    csv += `"${d["Full name"] || ""}","${d["Age"] || ""}","${d["Gender"] || ""}","${d["Contact number"] || ""}","${d["Email"] || ""}","${d["Permanent Address(Enter District)"] || ""}","${d["Current Address (Enter District)"] || ""}","${d["Blood Group(Enter in Bold. Eg:- B+)"] || ""}","${d["Willing to donate"] || ""}","${d["Any existing health conditions?"] || ""}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "filtered_blood_donors.csv";
  link.click();
}


async function exportPDF() {
  if (filteredDonors.length === 0) return alert("No data to export.");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "A4" });

  doc.setFontSize(16);
  doc.text(" Filtered Blood Donor Directory", doc.internal.pageSize.getWidth() / 2, 40, { align: "center" });

  const headers = [
    [
      "Name", "Age", "Gender", "Contact", "Email",
      "Permanent Addr", "Current Addr",
      "Blood Group", "Donate?", "Health Issues"
    ]
  ];

  const rows = filteredDonors.map(d => [
    d["Full name"] || "",
    d["Age"] || "",
    d["Gender"] || "",
    d["Contact number"] || "",
    d["Email"] || "",
    d["Permanent Address(Enter District)"] || "",
    d["Current Address (Enter District)"] || "",
    d["Blood Group(Enter in Bold. Eg:- B+)"] || "",
    d["Are you willing to donate blood in future emergencies?  "] || "",
    d["Any existing health conditions?"] || ""
  ]);

  doc.autoTable({
    head: headers,
    body: rows,
    startY: 60,
    theme: 'striped',
    headStyles: {
      fillColor: [214, 40, 40],
      textColor: [255, 255, 255],
      fontSize: 10,
    },
    styles: {
      fontSize: 8,
      cellPadding: 4,
      overflow: 'linebreak',
    },
    columnStyles: {
      0: { cellWidth: 70 },
      1: { cellWidth: 30 },
      2: { cellWidth: 40 },
      3: { cellWidth: 70 },
      4: { cellWidth: 90 },
      5: { cellWidth: 70 },
      6: { cellWidth: 70 },
      7: { cellWidth: 50 },
      8: { cellWidth: 40 },
      9: { cellWidth: 90 },
    },
    margin: { top: 60 },
  });

  doc.save("filtered_blood_donors.pdf");
}


function populateDropdowns(data) {
  const groupSet = new Set();
  const locationSet = new Set();

  data.forEach(donor => {
    // Normalize and clean up input
    const group = (donor["Blood Group(Enter in Bold. Eg:- B+)"] || "").trim().toUpperCase();
    const location = (donor["Current Address (Enter District)"] || "").trim().toLowerCase();

    // Add only if not empty
    if (group) groupSet.add(group);
    if (location) locationSet.add(location);
  });

  const groupDropdown = document.getElementById("searchGroup");
  const locationDropdown = document.getElementById("searchLocationDropdown");

  groupDropdown.innerHTML = `<option value="">All Blood Groups</option>`;
  locationDropdown.innerHTML = `<option value="">All Locations</option>`;

  // Add sorted options
  [...groupSet].sort().forEach(group => {
    groupDropdown.innerHTML += `<option value="${group}">${group}</option>`;
  });

  [...locationSet].sort().forEach(location => {
    const capitalized = location.replace(/\b\w/g, l => l.toUpperCase()); // e.g., mysuru ‚Üí Mysuru
    locationDropdown.innerHTML += `<option value="${location}">${capitalized}</option>`;
  });
}


function filterTable() {
  const name = document.getElementById("searchName").value.toLowerCase();
  const location = document.getElementById("searchLocationDropdown").value.toLowerCase();
  const group = document.getElementById("searchGroup").value;

  filteredDonors = donors.filter(donor => {
    const donorName = (donor["Full name"] || "").toLowerCase();
    const donorLocation = (donor["Current Address (Enter District)"] || "").toLowerCase();
    const donorGroup = donor["Blood Group(Enter in Bold. Eg:- B+)"] || "";
    return (
      donorName.includes(name) &&
      donorLocation.includes(location) &&
      (group === "" || donorGroup === group)
    );
  });

  renderTable(filteredDonors);
}

document.getElementById("searchName").addEventListener("input", filterTable);
document.getElementById("searchLocationDropdown").addEventListener("change", filterTable);
document.getElementById("searchGroup").addEventListener("change", filterTable);

fetchData();

function sortTable() {
  const sortColumn = document.getElementById("sortColumn").value;
  const sortOrder = document.getElementById("sortOrder").value;

  if (!sortColumn) return;

  filteredDonors.sort((a, b) => {
    const valA = (a[sortColumn] || "").toString().toLowerCase();
    const valB = (b[sortColumn] || "").toString().toLowerCase();

    if (valA < valB) return sortOrder === "asc" ? -1 : 1;
    if (valA > valB) return sortOrder === "asc" ? 1 : -1;
    return 0;
  });

  renderTable(filteredDonors);
}

</script>

</body>
</html>
